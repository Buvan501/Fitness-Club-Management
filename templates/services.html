{% extends 'base.html' %}

{% block title %}Fitness Classes | FitClub Pro{% endblock %}

{% block content %}
<div class="container py-5">
    <!-- Page Header -->
    <div class="row mb-5">
        <div class="col-lg-8 mx-auto text-center">
            <h1 class="display-4 fw-bold mb-3">Our Fitness Classes</h1>
            <p class="lead text-muted">Discover a wide range of classes designed to help you achieve your fitness goals. From high-intensity workouts to mindful practices, we have something for everyone.</p>
        </div>
    </div>

    <!-- Class Categories Filter -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-center flex-wrap gap-2">
                <button class="btn btn-outline-primary active" data-filter="all">All Classes</button>
                <button class="btn btn-outline-primary" data-filter="cardio">Cardio</button>
                <button class="btn btn-outline-primary" data-filter="strength">Strength</button>
                <button class="btn btn-outline-primary" data-filter="yoga">Yoga & Pilates</button>
                <button class="btn btn-outline-primary" data-filter="hiit">HIIT</button>
                <button class="btn btn-outline-primary" data-filter="dance">Dance</button>
            </div>
        </div>
    </div>

    <!-- Classes Grid -->
    <div class="row g-4" id="classesGrid">
        {% for class_ in classes %}
        <div class="col-lg-4 col-md-6 class-item" data-category="{{ class_.category.lower() }}">
            <div class="card h-100 border-0 shadow-sm hover-lift">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <span class="badge bg-primary">{{ class_.category }}</span>
                        <span class="badge bg-success">${{ "%.2f"|format(class_.price) }}</span>
                    </div>
                    
                    <h5 class="card-title mb-3">{{ class_.name }}</h5>
                    <p class="card-text text-muted mb-3">{{ class_.description or 'Join this exciting class to improve your fitness and have fun!' }}</p>
                    
                    <div class="row text-center mb-3">
                        <div class="col-4">
                            <div class="border-end">
                                <h6 class="text-primary mb-1">{{ class_.duration_minutes }}</h6>
                                <small class="text-muted">Minutes</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="border-end">
                                <h6 class="text-success mb-1">{{ class_.max_capacity }}</h6>
                                <small class="text-muted">Max Size</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <h6 class="text-info mb-1">{{ class_.trainer.user.first_name }}</h6>
                            <small class="text-muted">Trainer</small>
                        </div>
                    </div>
                    
                    <div class="d-grid">
                        {% if current_user.is_authenticated and current_user.has_role('member') %}
                            <button class="btn btn-primary" onclick="bookClass({{ class_.id }})">
                                <i class="bi bi-calendar-plus me-2"></i>Book Class
                            </button>
                        {% elif current_user.is_authenticated %}
                            <span class="text-muted text-center">Only members can book classes</span>
                        {% else %}
                            <a href="{{ url_for('login') }}" class="btn btn-outline-primary">
                                <i class="bi bi-box-arrow-in-right me-2"></i>Login to Book
                            </a>
                        {% endif %}
                    </div>
                </div>
                
                <div class="card-footer bg-transparent border-0 pt-0">
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">
                            <i class="bi bi-clock me-1"></i>Multiple times available
                        </small>
                        <button class="btn btn-sm btn-outline-secondary" onclick="viewSchedule({{ class_.id }})" data-bs-toggle="tooltip" title="View schedule">
                            <i class="bi bi-calendar-week me-1"></i>Schedule
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <div class="col-12 text-center py-5">
            <i class="bi bi-calendar-x display-1 text-muted mb-3"></i>
            <h3 class="text-muted">No Classes Available</h3>
            <p class="text-muted">Check back later for new class offerings.</p>
        </div>
        {% endfor %}
    </div>

    <!-- Call to Action -->
    <div class="row mt-5">
        <div class="col-12">
            <div class="card bg-primary text-white text-center py-5">
                <div class="card-body">
                    <h3 class="mb-3">Ready to Start Your Fitness Journey?</h3>
                    <p class="lead mb-4">Join our community and transform your life with our expert-led classes.</p>
                    {% if current_user.is_authenticated %}
                        <a href="{{ url_for('member_classes') }}" class="btn btn-light btn-lg">
                            <i class="bi bi-calendar-plus me-2"></i>Browse All Classes
                        </a>
                    {% else %}
                        <a href="{{ url_for('register') }}" class="btn btn-light btn-lg me-3">
                            <i class="bi bi-person-plus me-2"></i>Join Now
                        </a>
                        <a href="{{ url_for('login') }}" class="btn btn-outline-light btn-lg">
                            <i class="bi bi-box-arrow-in-right me-2"></i>Sign In
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Class Schedule Modal -->
<div class="modal fade" id="scheduleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Class Schedule</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="scheduleContent">
                    <!-- Schedule content will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Booking Modal -->
<div class="modal fade" id="bookingModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Book Class</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="bookingForm">
                    <div class="mb-3">
                        <label for="classSchedule" class="form-label">Select Time Slot</label>
                        <select class="form-select" id="classSchedule" required>
                            <option value="">Choose a time slot...</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="bookingDate" class="form-label">Select Date</label>
                        <input type="date" class="form-control" id="bookingDate" required min="{{ today }}">
                    </div>
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <small>You can book up to 2 weeks in advance. Cancellations must be made 24 hours before class.</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="bookingForm" class="btn btn-primary">Confirm Booking</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Filter functionality
document.querySelectorAll('[data-filter]').forEach(button => {
    button.addEventListener('click', function() {
        const filter = this.getAttribute('data-filter');
        
        // Update active button
        document.querySelectorAll('[data-filter]').forEach(btn => btn.classList.remove('active'));
        this.classList.add('active');
        
        // Filter classes
        document.querySelectorAll('.class-item').forEach(item => {
            if (filter === 'all' || item.getAttribute('data-category').includes(filter)) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
    });
});

// View schedule
function viewSchedule(classId) {
    const modalEl = document.getElementById('scheduleModal');
    const scheduleContent = document.getElementById('scheduleContent');
    scheduleContent.innerHTML = '<div class="text-center py-4"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>';

    fetch(`/api/class-schedules/${classId}`)
      .then(r => r.json())
      .then(json => {
        if (!json.success) {
          scheduleContent.innerHTML = `<div class="alert alert-danger">${json.message || 'Failed to load schedule'}</div>`;
          return;
        }
        const rows = json.data.map(s => `
          <tr>
            <td>${s.day_name}</td>
            <td>${s.start_time} - ${s.end_time}</td>
            <td>${s.room}</td>
          </tr>`).join('');
        scheduleContent.innerHTML = `
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead>
                <tr>
                  <th>Day</th>
                  <th>Time</th>
                  <th>Room</th>
                </tr>
              </thead>
              <tbody>${rows || '<tr><td colspan="3" class="text-center text-muted">No active schedules</td></tr>'}</tbody>
            </table>
          </div>`;
      })
      .catch(() => {
        scheduleContent.innerHTML = '<div class="alert alert-danger">Error loading schedule</div>';
      })
      .finally(() => {
        new bootstrap.Modal(modalEl).show();
      });
}

// Book class
function bookClass(classId) {
    // This would typically fetch available schedules from the backend
    const scheduleSelect = document.getElementById('classSchedule');
    scheduleSelect.innerHTML = `
        <option value="">Choose a time slot...</option>
        <option value="1">Monday 9:00 AM - 10:00 AM (Studio A)</option>
        <option value="2">Wednesday 6:00 PM - 7:00 PM (Studio B)</option>
        <option value="3">Friday 7:00 AM - 8:00 AM (Studio A)</option>
    `;
    
    // Set minimum date to today
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('bookingDate').min = today;
    
    new bootstrap.Modal(document.getElementById('bookingModal')).show();
}

// Handle booking form submission
document.getElementById('bookingForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const classScheduleId = document.getElementById('classSchedule').value;
    const bookingDate = document.getElementById('bookingDate').value;
    
    if (!classScheduleId || !bookingDate) {
        alert('Please select both a time slot and date.');
        return;
    }
    
    // Send booking request to backend
    fetch('/api/book-class', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            class_schedule_id: classScheduleId,
            booking_date: bookingDate
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Class booked successfully!');
            bootstrap.Modal.getInstance(document.getElementById('bookingModal')).hide();
            // Optionally refresh the page or update UI
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while booking the class.');
    });
});

// Add hover effect to cards
document.querySelectorAll('.card').forEach(card => {
    card.addEventListener('mouseenter', function() {
        this.style.transform = 'translateY(-5px)';
        this.style.transition = 'transform 0.3s ease';
    });
    
    card.addEventListener('mouseleave', function() {
        this.style.transform = 'translateY(0)';
    });
});
</script>
{% endblock %}